# Сравнение аналогов

## Основные определения

См. также [основные определения с предыдущего задания](https://github.com/moevm/scientific_writing-2024/blob/main/1384_Belokobylsky_IV/key_questions.md#основные-определения).

- Мастер - узел управления кластером Kubernetes, находится в зоне ответственности компании, предоставляющей услуги
  по управлению Облачной Платформой.
- Воркер - узел, на котором работает ПО клиента, находится в его зоне ответственности
- API-хост - узел, на котором работает микросервис, взаимодействующий с API Облачной Платформы и реализующий основную
  автоматизацию. К кластеру Kubernetes не имеет прямого отношения. Микросервисы, установленные на API-хостах,
  взаимодействуют только с микросервисами на мастерах.

## Ограничения и требования

В первую очередь необходимо упомянуть об ограничениях, которые накладываются на систему:

1. Изменение API Облачной Платформы и API Kubernetes, которые необходимо использовать, невозможно;
2. Ввиду ограничений безопасности и разграничения зон ответственности вызовы микросервисов на воркерах
   возможны только из микросервисов на мастерах. Таким образом, невозможны прямые вызовы от API-хостов до воркеров.

Также устанавливаются следующие функциональные требования:

1. Возможность приостановки бизнес-функции. Это необходимо для обеспечения обслуживания кластера в интервалы, указанные
   клиентом, для максимальной доступности в часы высокой нагрузки.
2. Возможность распараллеливания этапов выполнения задач. Это необходимо для ускорения обслуживания и масштабирования
   кластера. Это актуально в задаче по обновлению версии Kubernetes в кластере - для этого необходимо переустановить
   на всех воркерах ПО, что может занимать большое количество времени при последовательной обработке этапов в больших 
   кластерах - вплоть до 12 часов.
3. Возможность указания процента недоступности воркеров. Это актуально в задачах по обновлению версии Kubernetes,
   когда необходимо выполнить переустановку всех воркеров в кластере. С учетом параллельности необходимо
   обеспечить минимально допустимое количество воркеров в кластере.
4. Возможность приоритезации задач и выполнения их согласно заданным приоритетам.

Опционально полное соответствие ACID, допустима также согласованность в конечном счете и обеспечение изоляции
при помощи контрмер [1].

## Принцип отбора аналогов

В роли сравнительных аналогов были рассмотрены архитектурные подходы и методы, применяемые для обеспечения откатов в
случае возникновения ошибок при взаимодействии между микросервисами, таким образом, поддерживая целостность выполняемых
бизнес-функций. Основной критерие опираются на ограничения и требования, которые описаны выше. Поиск аналогов 
осуществлялся с помощью ресурса Google Scholar, где применялись следующие запросы: "distributed systems transactions", 
"transactions in microservices", "distributed transactions", "distributed data consistency". Для сравнения 
производительности подходов применялась поисковая система Google, с запросами по конкретным аналогам.

### Двухфазная фиксация (2PC)

Подход предполагает наличие координатора - узла, который отвечает за выполнение транзакций. Остальные узлы называют
когортами. При необходимости выполнить транзакцию он производит два этапа [2]:

1. Подготовка: координатор уведомляет когорт о необходимости выполнения операции. Когорты принимают решение - могут ли
   они зафиксировать относящуюся к ним часть транзакции, и уведомляют о своем решении координатора.
2. Фиксация / прерывание: если хотя бы одна когорта не может зафиксировать часть транзакции, координатор направляет всем
   остальным запрос на прерывание - откат транзакции. В противном случае координатор уведомляет о необходимости
   фиксации, которая гарантированно завершится успешно.

Данный подход требователен к взаимодействиям с внешними API: они должны поддерживать двухфазную фиксацию, поэтому он
применим не везде [1]. Также в этом подходе при отказе координатора после выполнения подготовки система остается в
неопределенном состоянии до введения координатора в строй. При этом, двухфазная фиксация предоставляет блокирующий
алгоритм [2].

### Трехфазная фиксация (3PC)

Представляет собой улучшение двухфазной фиксации: добавление ей устойчивости к отказам координатора в процессе
выполнения транзакции. В этом подходе добавляется еще один второй шаг (после подготовки): координатор рассылает
состояния когорт, выявленные в ходе фазы предложения, позволяя протоколу продолжить работу даже в случае отказа 
координатора. Таким образом, происходит голосование, которое в случае выполнения приводит к фиксации транзакции [2].

Этот подход более устойчив к отказам координатора, так как когорты могут принять детерминированное решение, однако
возможна ситуация, когда одни когорты не получили состояния других, например, ввиду проблем с сетью.
В этом случае возможно приведение данных к несогласованному состоянию до восстановления сети: часть когорт
зафиксируют транзакцию, а часть - прервут [2].

Трехфазная фиксация также применима не везде ввиду ограничений на внешние API [1].

### Сага хореография

C. Richardson [1] описывает этот подход как последовательность локальных транзакций, каждая из которых обновляет данные в
одном сервисе с фиксацией внутри этого сервиса. В случае обнаружения отказа начинаются операции компенсации: выполнение
обратных изменений для приведения системы в согласованное состояние.

Из-за использования локальных транзакций, сага не позволяет сделать систему полностью удовлетворяющую свойствам ACID [1]:

- Нет изоляции, ее необходимо поддерживать отдельно с помощью различных контрмер, подробно описанных в книге
  "Microservices patterns: with examples in Java".
- Согласованность только в конечном счете. Так как представляет собой последовательность локальных транзакций, система в
  целом в процессе их выполнения может оставаться в несогласованном состоянии.

Хореография координируется всеми узлами сразу: в случае возникновения ошибки в одном из них бизнес-функция
прерывается и все операции выполняются в обратном порядке. Участники хореографии подписываются на события друг друга и
при выполнении локальной транзакции атомарно вызывается событие для следующего участника [1].

Такой подход снижает связность между сервисами, что позволяет его использовать в системах, где невозможна реализация
координатора с максимальным количеством связей. Эти ограничения могут быть вызваны, например, обеспечением безопасности,
когда один из сервисов запускается во внешнем контуре и доступ к нему осуществляется через сервис-прослойку [1].

### Сага оркестрация 

Для координации оркестрации используется выделенный узел, задачей которого является рассылка сообщений по другим узлам с
целью либо выполнения какой-либо операции, либо ее отката. Взаимодействие строится по принципу запрос-ответ и может
выполняться асинхронно [1].

Наличие оркестратора позволяет более гибко управлять выполняемыми бизнес-функциями, а также позволяет в единственном
месте отслеживать их состояние. Это полезно при необходимости выполнения части локальных транзакций параллельно или
приостановке бизнес-функции на какое-то время [1].

### Spanner

Подход представляет собой надстройку над двухфазной фиксацией: для отказоустойчивости добавляются группы консенсуса
каждого узла, работающие на основе алгоритма Paxos, а также основе системы лежит технология TrueTime, которая
предоставляет согласованное время для всех узлов. Это позволяет назначать каждой транзакции временную метку,
упорядочивая транзакции без необходимости дополнительной координации между узлами во время выполнения [3].

В случае сбоев благодаря наличию групп консенсуса данные можно восстановить за счет реплик. Однако восстановление не
всегда возможно, потому для операций записи выделяется лидер, который может обеспечить откат транзакции. При этом
операции чтения не блокируются, в отличие от двухфазной фиксации [3].

Таким образом, этот подход исправляет недостатки в надежности и производительности двухфазной фиксации, при этом
является более трудоемким.

### Calvin

В этом подходе порядок выполнения транзакций детерминирован: перед тем, как поставить блокировку, узлы системы
договариваются о плане выполнения, после чего транзакция выполняется без необходимости координации. Этот подход улучшает
производительность в сравнении с 2PC и 3PC, так как отсутствует блокировка на период между подготовкой и фиксацией [4].

Чтобы порядок транзакций был детерминирован, в этом подходе используется сущность Задатчик - точка входа всех
транзакций, который как раз упорядочивает серию транзакций и отправляет ее планировщику. Планировщик управляет рабочим
потоком для выполнения транзакций в заданном порядке. При реализации этого подхода подразумевается наличие нескольких
задатчиков и планировщиков, потому для их синхронизации используется алгоритм консенсуса Paxos или репликация с
выделенным лидером, в зависимости от того, что важнее: устойчивость к отказам или производительность системы. Для
определения порядка в Calvin используется два набора: чтения и записи. Первый определяет зависимости между данными, а
второй - побочные эффекты выполнения. Таким образом вычисляется, какие операции могут быть выполнены параллельно с
обеспечением линеаризуемости [4].

Однако не все можно детерминировать, как например, аппаратные ошибки, которые могут повлечь недоступность узла. В этом
случае в зависимости от характера ошибки планировщик принимает решение: стоит считать транзакцию отклоненной и выполнить
откат остальных операций, или же частично завершенной - тогда выполняются попытки повторить операцию [5].

В статье [6] Abadi D. сравнивает Calvin и Spanner по параметрам, определяющим производительность подходов: параллельное
выполнение транзакций, наличие задержек чтения и записи, масштабирование (репликация, консенсус), дополнительные 
операции. Рассмотрение идет в отрыве от конкретной системы, описываются идеальные реализации каждого из подходов, 
как их предлагают авторы в статях[3,4]. В конечном итоге Abadi D. приходит к выводу, что производительность 
Spanner и Calvin практически идентична.

## Критерии сравнения аналогов

### Соответствие ACID

Данный критерий определяет, насколько реализация подхода построения архитектуры будет соответствовать свойствам ACID в
целом и на каком уровне, если речь идет о согласованности. Среди уровней в рамках обзора будут использоваться [5]:

- Линеаризуемость
- Согласованность в конечном счете

### Уровень контроля выполняемых бизнес-функций

В рамках этого критерия оценивается возможность гибкого управления выполняемыми бизнес-функциями. Под гибкостью
подразумевается возможность изменения процесса выполнения бизнес-функции прямо по ходу этого выполнения. Можно привести
следующие примеры контроля:

- приостановка по таймеру или какой-либо бизнес-логике для продолжения позднее;
- распараллеливание этапов выполнения.

### Системные ограничения

В рамках данного критерия рассматриваются все ограничения, которые накладываются на систему при использовании подхода.

### Относительная производительность

По данному критерию учитывается количество дополнительных сетевых вызовов при выполнении бизнес-функции,
которые необходимы для реализации каждого подхода, а также наличие блокировки для других бизнес-функций.
В качестве оценки ставится число, означающее позицию в рейтинге по относительной производительности каждого из подходов.

### Количество точек отказа

В рамках данного критерия считается количество узлов, при отказе которых дальнейшая работа системы в режиме записи
невозможна. При оценке не учитывается репликация, если для ее реализации необходимо использование дополнительных
алгоритмов консенсуса, не входящих в описание подхода. Под возможностью работы системы подразумевается возможность
корректно выполнять хотя бы одну бизнес-функцию с побочными эффектами.

Значение M в означает минимальное число реплицированных копий узла лидера / координатора / оркестратора / задатчика
(в зависимости от терминологии подхода) по используемому алгоритму консенсуса или репликации. Значение N означает
общее число узлов и выставляется, если в рамках подхода отказ какого-либо узла не приводит к полному отказу системы.

## Таблица сравнения аналогов

[//]: # (Таблицу рекомендуется читать в режиме просмотра - так есть переносы строк в ячейках.)

| Аналог      | Соответствие ACID     | Уровень контроля                                                                                                                                      | Системные ограничения                                                                                | Производительность                                                                    | Точек отказа |
|-------------|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|--------------|
| 2PC         | ACID, линеаризуемость | Отсутствует приостановка ввиду блокировок других бизнес-функций                                                                                       | Внешние API должны удовлетворять интерфейсу 2PC                                                      | 5, выполнение двух сетевых вызовов всегда, использование блокировок                   | 1            |
| 3PC         | ACID, линеаризуемость | Отсутствует приостановка ввиду блокировок других бизнес-функций                                                                                       | Внешние API должны удовлетворять интерфейсу 3PC или 2PC                                              | 6, выполнение трех сетевых вызовов всегда, использование блокировок                   | 1            |
| Хореография | ACD, в конечном счете | Возможна приостановка по таймеру или через общее хранилище. Параллельность ненадежна, ввиду отсутствия компенсаций при ошибках в параллельных задачах | Отсутствуют                                                                                          | 1, дополнительные операции только при отказе                                          | N            |
| Оркестрация | ACD, в конечном счете | Максимальный                                                                                                                                          | Оркестратор должен иметь прямую связь со всеми остальными узлами                                     | 2, взаимодействие с оркестратором                                                     | 1            |
| Spanner     | ACID, линеаризуемость | Максимальный, приостановка возможна благодаря TrueTime                                                                                                | Внешние API должны удовлетворять интерфейсу Spanner или 2PC                                          | 3-4, поддержание консенсуса, использование 2PC [6]                                    | M            |
| Calvin      | ACID, линеаризуемость | Невозможны недетерминированные приостановки                                                                                                           | Возможность детерминирования операций, задатчик должен иметь прямую связь со всеми остальными узлами | 3-3, поддержание консенсуса / репликации, взаимодействие задатчика и планировщика [6] | M            |

## Выводы по итогам сравнения

Анализируя результаты таблицы, можно сделать вывод о том, что среди рассмотренных подходов нет универсальных -
обладающих следующими критериями:

- Минимальный уровень системных ограничений
- Соответствие ACID с линеаризуемостью, а не согласованностью в конечном счете
- Максимальным уровнем контроля
- Высокой производительностью
- Максимальным числом точек отказа

Среди рассмотренных подходов выявляется закономерность, что обеспечение строгого соответствия ACID приводит к
дополнительным системным ограничениям и потере производительности.

## Выбор метода решения

По указанным ограничениям из списка следующие подходы не подходят в качестве единственного варианта ввиду требований ко
внешнему API: 2PC, 3PC и Spanner. Все они, а также Calvin и оркестрация не подходят и по другому ограничению - в них
используется координатор / задатчик / оркестратор, которому необходима связь до всех микросервисов системы.

Подходы 2PC, 3PC и хореография не соответствует функциональным требованиям, поэтому частичное использование 2PC и 3PC
нецелесообразно.

Таким образом, возможны следующие варианты, удовлетворяющие всем ограничениям:

1. Calvin на API-хостах и хореография в кластере;
2. Оркестрация на API-хостах и хореография в кластере;
3. Spanner в сервисах, не взаимодействующих со внешним API и хореография в остальных случаях.

Третий вариант не подходит под текущую систему, так как в системе бо́льшая часть функциональности 
построена на взаимодействии со внешними API.

Основное их отличие заключается в детерминированности Calvin, необходимой для полного соответствия ACID. По этой причине
Calvin не позволяет использовать недетерминированные приостановки. Ввиду более трудоемкой реализации и несоответствия 
функциональному требованию, оркестрация выигрывает, так как полное соответствие ACID опционально. Однако для
отказоустойчивости - требуется дополнительный алгоритм консенсуса (Paxos, Raft или др.).

При этом также можно рассмотреть подход с множеством оркестраторов - один на API-хосте и по одному на каждый кластер, 
однако хореография обеспечивает бо́льшую производительность и устойчивость к отказам в сравнении с оркестрацией, и 
система на ее основе соответствует функциональным требованиям и ограничениям.

Таким образом, в качестве подхода к построению архитектуры системы рекомендуется комбинация из оркестрации на API-хостах
и хореографии в кластере Kubernetes.

## Список использованных источников

1. Richardson C. Microservices patterns: with examples in Java. – "Simon and Schuster", 2018
2. Tanenbaum A. S., Van Steen M. Distributed systems. – CreateSpace Independent Publishing Platform, 2017.
3. Corbett J. C. et al. Spanner: Google’s globally distributed database //ACM Transactions on Computer Systems (TOCS). – 2013. – Т. 31. – №. 3. – С. 1-22.
4. Thomson A. et al. Calvin: fast distributed transactions for partitioned database systems //Proceedings of the 2012 ACM SIGMOD international conference on management of data. – 2012. – С. 1-12.
5. Petrov A. Database Internals: A deep dive into how distributed data systems work. – O'Reilly Media, 2019.
6. Abadi D. Spanner vs. Calvin: Distributed Consistency at Scale [Электронный ресурс] // Fauna blog. 2017. 6 апреля. URL: https://fauna.com/blog/distributed-consistency-at-scale-spanner-vs-calvin (дата обращения: 09.12.2024).
